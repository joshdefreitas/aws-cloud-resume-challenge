name: Deploy to S3 behind CloudFront

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/OIDC-GitHub-CloudResume-S3
          aws-region: us-east-2   # <- your bucketâ€™s region

      - name: Sanity check
        run: aws sts get-caller-identity

      # Upload long-lived assets (cache a year), exclude HTML
      - name: Upload assets
        run: |
          aws s3 sync website s3://$AWS_S3_BUCKET \
            --exclude "*.html" \
            --cache-control "public,max-age=31536000,immutable" \
            --follow-symlinks --delete
        env:
          AWS_S3_BUCKET: ${{ vars.AWS_S3_BUCKET }}

      # Upload HTML (no-cache) so updates show instantly
      - name: Upload HTML
        run: |
          aws s3 sync website s3://$AWS_S3_BUCKET \
            --exclude "*" --include "*.html" \
            --cache-control "no-cache" \
            --follow-symlinks
        env:
          AWS_S3_BUCKET: ${{ vars.AWS_S3_BUCKET }}

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths "/*"
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
